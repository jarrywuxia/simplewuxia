rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- PLAYER DATA (The Bank Vault) ---
    match /players/{userId} {
      // 1. READ: You can see your own stats
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // 2. CREATE: You can create a NEW character (for CharacterCreation.js)
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // 3. UPDATE/DELETE: BLOCKED. 
      // The client cannot change XP/Gold/Items. 
      // Only the Server (Cloud Functions) can do this now.
      allow update, delete: if false;
    }
    
    // --- USERNAMES (The Registry) ---
    // We keep this open for now so CharacterCreation.js still works
    match /usernames/{username} {
      allow read: if request.auth != null;
      
      // Allow claiming a name
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
                       
      // Allow releasing a name (if you delete your account later)
      allow delete: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
    }
    
    // --- SAFETY NET ---
    // Block everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}